<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Calorie Buddy</title>
  <meta name="description" content="A simple, free calorie tracker with barcode scan. Works on your phone. Data stays on your device." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üçé</text></svg>">
  <style>
    :root{
      --bg:#0b0c10; --panel:#111318; --muted:#a6adbb; --text:#f6f7f9; --accent:#60a5fa; --danger:#ef4444; --ok:#10b981;
      --radius:18px; --pad:12px; --tap:16px;
    }
    *{box-sizing:border-box; min-width:0}
    html,body{height:100%; width:100%; overflow-x:hidden}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0c10,#0f1117);color:var(--text)}
    header{position:sticky;top:0;z-index:5;backdrop-filter:saturate(180%) blur(10px);background:rgba(17,19,24,.7);border-bottom:1px solid #1f2330}
    header .wrap{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    header h1{font-size:18px;margin:0;display:flex;gap:10px;align-items:center}
    .goal{font-size:12px;color:var(--muted)}

    main{padding-bottom:86px}

    .container{max-width:900px;margin:0 auto;padding:12px; width:100%; overflow-x:hidden}
    .card{background:var(--panel);border:1px solid #1f2330;border-radius:var(--radius);padding:var(--pad);box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden}
    .row{display:grid;gap:10px}

    .muted{color:var(--muted)}
    label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px}
    input,button,select{font:inherit}
    input[type="text"],input[type="number"],input[type="datetime-local"],select{width:100%;padding:14px;border-radius:14px;border:1px solid #2a3242;background:#0e121b;color:var(--text);font-size:16px}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:14px;border:1px solid #2a3242;background:#0e121b;color:var(--text);cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(180deg,#1f2937,#111827);border-color:#2a3242}
    .btn.accent{background:linear-gradient(180deg,#0ea5e9,#0284c7);border-color:#0891b2;color:#fff}
    .btn.green{background:linear-gradient(180deg,#10b981,#059669);border-color:#047857;color:#fff}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:#7f1d1d;color:#fff}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .grid2{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:10px}
    .list{display:grid;gap:10px}
    .entry{display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid #23283a;border-radius:14px;background:#0f1420}
    .entry .meta{display:flex;flex-direction:column;gap:4px}
    .entry .title{font-weight:700;font-size:15px}
    .entry .sub{font-size:12px;color:var(--muted)}
    .entry .cal{font-weight:800}
    .empty{padding:18px;border:1px dashed #2a3242;border-radius:14px;text-align:center;color:var(--muted)}

    nav.bottom{position:fixed;left:0;right:0;bottom:0;background:rgba(17,19,24,.9);backdrop-filter:saturate(180%) blur(10px);border-top:1px solid #1f2330;display:flex}
    nav.bottom button{flex:1;padding:10px 5px;background:transparent;border:0;color:var(--muted);font-size:12px;display:grid;gap:6px;place-items:center;cursor:pointer}
    nav.bottom button.active{color:var(--text)}

    /* Home progress */
    .progress-card{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:center}
    .ring-wrap{width:140px;height:140px;justify-self:center}
    .progress-stats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:20px;font-weight:800}
    .hide-xs{display:none}

    /* Log panel to keep page short */
    .log-panel{max-height:40vh;overflow:auto;-webkit-overflow-scrolling:touch;border:1px solid #23283a;border-radius:14px;padding:8px;background:#0f1420}

    /* Foods page */
    .food-item{display:flex;align-items:center;justify-content:space-between;background:#0f1420;border:1px solid #23283a;border-radius:14px;padding:12px}
    .food-left{display:flex;align-items:center;gap:10px}
    .food-ico{font-size:20px;line-height:1}
    .food-name{font-weight:700}
    .food-sub{font-size:12px;color:var(--muted)}
    .food-row-right{display:flex;gap:8px;align-items:center}
    .catSelect{width:auto;padding:8px 10px}

    /* Media queries */
    @media(min-width:760px){
      .progress-card{grid-template-columns:220px 1fr}
      .ring-wrap{width:220px;height:220px}
      .hide-xs{display:initial}
    }
    @media(max-width:560px){
      .grid2{grid-template-columns:1fr}
    }

    /* Safe sizing for media & charts */
    canvas{display:block;max-width:100%;width:100%}
    video{display:block;max-width:100%;height:auto;border-radius:14px;border:1px solid #262b3c;background:#000}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üçé Calorie Buddy</h1>
      <div class="goal">Daily goal: <span id="dailyGoalLabel">2000</span> kcal</div>
    </div>
  </header>

  <main>
    <div class="container row">

      <!-- HOME -->
      <section id="screen-home" class="card" aria-label="Home">
        <div class="row">
          <div class="progress-card">
            <div class="ring-wrap">
              <canvas id="progressChart"></canvas>
            </div>
            <div class="progress-stats">
              <div><div class="k">Today</div><div class="v" id="todayTotal">0 kcal</div></div>
              <div><div class="k">Remaining</div><div class="v" id="todayRemaining">0 kcal</div></div>
              <div class="hide-xs"><div class="k">This week</div><div class="v" id="weekTotal">0 kcal</div></div>
              <div class="hide-xs"><div class="k">This month</div><div class="v" id="monthTotal">0 kcal</div></div>
              <div class="grid2" style="grid-column:1/-1">
                <button class="btn green" id="addQuick">‚ûï Add</button>
                <button class="btn" id="scanSwitch">üì∑ Scan</button>
              </div>
            </div>
          </div>

          <div>
            <div style="font-weight:700;margin:2px 0 6px 0;display:flex;align-items:center;justify-content:space-between">
              <span>Today's log</span>
              <button class="btn" onclick="showScreen('charts')">üìà Details</button>
            </div>
            <div class="log-panel">
              <div id="logList" class="list"></div>
              <div id="logEmpty" class="empty" hidden>No items today. Tap <b>Add</b> or <b>Scan</b>.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- SCAN -->
      <section id="screen-scan" class="card" aria-label="Barcode scanner" hidden>
        <div class="row">
          <div class="muted">Tip: if scanning fails, enter the barcode below.</div>
          <video id="video" playsinline></video>
          <div class="grid2">
            <button class="btn accent" id="startScan">‚ñ∂Ô∏è Start</button>
            <button class="btn" id="stopScan" disabled>‚èπÔ∏è Stop</button>
          </div>
          <div class="grid2">
            <input type="text" id="manualBarcode" inputmode="numeric" pattern="[0-9]*" placeholder="Enter barcode" />
            <button class="btn" id="lookupBarcode">üîé Lookup</button>
          </div>
          <div id="scanResult" class="row"></div>
        </div>
      </section>

      <!-- CHARTS (detailed) -->
      <section id="screen-charts" class="card" aria-label="Charts" hidden>
        <div class="row">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" data-chart="day">Day</button>
            <button class="btn" data-chart="week">Week</button>
            <button class="btn" data-chart="month">Month</button>
          </div>
          <canvas id="calChart" height="240"></canvas>
          <div class="muted">Tip: the faint dashed line marks your daily goal.</div>
        </div>
      </section>

      <!-- FOODS (memory) -->
      <section id="screen-foods" class="card" aria-label="Foods" hidden>
        <div class="row">
          <div class="grid2">
            <input type="text" id="foodSearch" placeholder="Search saved foods" />
            <div class="grid2">
              <select id="filterCategory">
                <option value="all">All categories</option>
              </select>
              <select id="sortFoods">
                <option value="recent">Sort: Recent</option>
                <option value="name">Sort: Name A‚ÄìZ</option>
                <option value="category">Sort: Category</option>
              </select>
            </div>
          </div>
          <div id="foodsList" class="list"></div>
          <div id="foodsEmpty" class="empty" hidden>No saved foods yet. When you add an item, I remember its calories.</div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="screen-settings" class="card" aria-label="Settings" hidden>
        <div class="row">
          <div class="grid2">
            <div>
              <label for="dailyGoal">Daily calorie goal</label>
              <input type="number" id="dailyGoal" min="500" max="10000" step="10" value="2000" />
            </div>
            <div style="display:flex;align-items:flex-end;gap:10px">
              <button class="btn primary" id="saveGoal">Save goal</button>
              <button class="btn" id="resetToday">Reset today</button>
            </div>
          </div>
          <div class="grid2">
            <button class="btn" id="exportData">‚¨áÔ∏è Export data</button>
            <button class="btn" id="importDataBtn">‚¨ÜÔ∏è Import data</button>
            <input type="file" id="importFile" accept="application/json" style="display:none" />
            <button class="btn danger" id="clearAll">üóëÔ∏è Clear all data</button>
          </div>
          <div class="muted">About: data stays on your device. Barcode lookups use the free Open Food Facts API.</div>
          <div class="muted">Version <span id="appVersion">1.2.0</span></div>
        </div>
      </section>

    </div>
  </main>

  <nav class="bottom" aria-label="Bottom navigation">
    <button class="active" data-screen="home">üè† Home</button>
    <button data-screen="scan">üì∑ Scan</button>
    <button data-screen="charts">üìà Charts</button>
    <button data-screen="foods">üçΩ Foods</button>
    <button data-screen="settings">‚öôÔ∏è Settings</button>
  </nav>

  <!-- Add/Edit dialog (simplified) -->
  <dialog id="entryDialog">
    <div class="dlg" style="padding:16px">
      <form id="entryForm">
        <h3 id="dlgTitle" style="margin:0 0 8px 0">Add entry</h3>
        <div class="row">
          <div>
            <label for="foodName">Food name</label>
            <input type="text" id="foodName" list="foodNames" placeholder="e.g., Chips" required />
            <datalist id="foodNames"></datalist>
          </div>
          <div>
            <label for="calories">Calories</label>
            <input type="number" id="calories" min="0" step="1" placeholder="e.g., 150" required />
          </div>
          <div>
            <label for="when">Date & time</label>
            <input type="datetime-local" id="when" required />
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;gap:10px;margin-top:10px">
          <button type="button" class="btn" id="cancelDlg">Cancel</button>
          <button type="submit" class="btn green" id="saveEntry">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Libraries -->
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
  // ======= Utilities =======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtKcal = n => `${Math.round(n)} kcal`;
  const toLocalDatetime = (d) => {
    const pad = n => (n<10? '0'+n : n);
    const dt = new Date(d);
    const y = dt.getFullYear(); const m = pad(dt.getMonth()+1); const da = pad(dt.getDate());
    const h = pad(dt.getHours()); const mi = pad(dt.getMinutes());
    return `${y}-${m}-${da}T${h}:${mi}`;
  }
  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
  const norm = s => (s||'').trim().toLowerCase();

  // ======= Categories & icons =======
  const CATEGORIES = ['Meals','Snacks','Drinks','Fruit','Veggies','Dairy','Grains','Sweets','Fast Food','Other'];
  const CAT_ICON = {
    'Meals':'üçΩÔ∏è','Snacks':'ü•®','Drinks':'ü•§','Fruit':'üçé','Veggies':'ü•ï','Dairy':'üßÄ','Grains':'üåæ','Sweets':'üç´','Fast Food':'üçî','Other':'üîñ'
  };
  const KEYWORDS = [
    ['Meals',['meal','rice','pasta','noodle','curry','stew','soup','bowl','plate','wrap','sandwich','salad','omelet','eggs','chicken','beef','pork','fish','tofu'] ],
    ['Snacks',['snack','chips','crisps','nuts','trail','granola','bar','popcorn','cracker','pretzel','cookie'] ],
    ['Drinks',['drink','soda','cola','juice','water','coffee','latte','tea','milkshake','energy','gatorade'] ],
    ['Fruit',['apple','banana','berry','orange','grape','mango','kiwi','pear','peach','fruit'] ],
    ['Veggies',['salad','veg','vegetable','carrot','broccoli','spinach','kale','lettuce','pepper'] ],
    ['Dairy',['milk','yogurt','cheese','butter','cream'] ],
    ['Grains',['bread','bagel','tortilla','oat','cereal','rice','quinoa'] ],
    ['Sweets',['candy','chocolate','cake','donut','doughnut','ice cream','dessert','muffin'] ],
    ['Fast Food',['burger','fries','pizza','taco','kebab','nugget','hot dog'] ],
  ];
  function inferCategory(name){
    const s = norm(name);
    for(const [cat, words] of KEYWORDS){ if(words.some(w=> s.includes(w))) return cat; }
    return 'Other';
  }
  function iconFor(cat){ return CAT_ICON[cat] || CAT_ICON['Other']; }

  // ======= Storage =======
  const STORAGE_KEY = 'cb_entries_v1';     // entries
  const GOAL_KEY = 'cb_goal_v1';
  const FOODS_KEY = 'cb_foods_v1';         // name -> {name, calories, timesUsed, lastUsedAt, category}

  let entries = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
  let dailyGoal = parseInt(localStorage.getItem(GOAL_KEY)||'2000',10);
  let foods = JSON.parse(localStorage.getItem(FOODS_KEY)||'{}');

  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    localStorage.setItem(GOAL_KEY, String(dailyGoal));
    localStorage.setItem(FOODS_KEY, JSON.stringify(foods));
    $('#dailyGoalLabel').textContent = dailyGoal;
  }

  // ======= Foods memory =======
  function rememberFood(name, calories){
    const key = norm(name); if(!key) return; const now = Date.now();
    const prev = foods[key]||{name: name.trim(), calories: Number(calories)||0, timesUsed:0, lastUsedAt:now, category: inferCategory(name)};
    foods[key] = {name: name.trim(), calories: Number(calories)||0, timesUsed:(prev.timesUsed||0)+1, lastUsedAt: now, category: prev.category || inferCategory(name)};
    persist(); buildFoodSuggestions(); renderFoods();
  }
  function findFood(name){ const f = foods[norm(name)]; return f? f.calories : null; }
  function setFoodCategory(name, cat){ const f = foods[norm(name)]; if(!f) return; f.category = cat; persist(); renderFoods(); buildFoodSuggestions(); }
  function deleteFood(name){ delete foods[norm(name)]; persist(); buildFoodSuggestions(); renderFoods(); }

  function buildFoodSuggestions(){
    const dl = $('#foodNames'); if(!dl) return; dl.innerHTML='';
    const arr = Object.values(foods).sort((a,b)=> (b.lastUsedAt||0)-(a.lastUsedAt||0)).slice(0,50);
    for(const f of arr){ const o = document.createElement('option'); o.value = f.name; dl.appendChild(o); }
  }

  // ======= Bottom nav =======
  const screens = ['home','scan','charts','foods','settings'];
  function showScreen(name){
    screens.forEach(s => {
      $('#screen-'+s).hidden = s!==name;
      document.querySelector(`nav.bottom button[data-screen="${s}"]`).classList.toggle('active', s===name);
    });
  }

  // ======= Totals & rendering =======
  function computeTotals(){
    const now = new Date();
    const startDay = new Date(); startDay.setHours(0,0,0,0);
    const startWeek = new Date(now); const day = (now.getDay()+6)%7; // Mon=0
    startWeek.setDate(now.getDate()-day); startWeek.setHours(0,0,0,0);
    const startMonth = new Date(now.getFullYear(), now.getMonth(), 1);

    const tDay = entries.filter(e=> new Date(e.when)>=startDay).reduce((a,b)=>a+(b.total||b.calories||0),0);
    const tWeek = entries.filter(e=> new Date(e.when)>=startWeek).reduce((a,b)=>a+(b.total||b.calories||0),0);
    const tMonth = entries.filter(e=> new Date(e.when)>=startMonth).reduce((a,b)=>a+(b.total||b.calories||0),0);

    $('#todayTotal').textContent = fmtKcal(tDay);
    $('#todayRemaining').textContent = fmtKcal(Math.max(dailyGoal - tDay, 0));
    $('#weekTotal').textContent = fmtKcal(tWeek);
    $('#monthTotal').textContent = fmtKcal(tMonth);

    updateProgressChart(tDay, dailyGoal);
  }

  function renderLog(){
    const list = $('#logList'); list.innerHTML='';
    const start = new Date(); start.setHours(0,0,0,0);
    const filtered = entries.filter(e=> new Date(e.when)>=start).sort((a,b)=> new Date(b.when)-new Date(a.when));
    $('#logEmpty').hidden = filtered.length>0;
    filtered.forEach(e=>{
      const el = document.createElement('div'); el.className='entry';
      const when = new Date(e.when);
      const calories = e.calories ?? e.total ?? 0;
      el.innerHTML = `
        <div class="meta">
          <div class="title">${e.name||'Untitled'}</div>
          <div class="sub">${when.toLocaleString()}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="cal">${fmtKcal(calories)}</div>
          <button class="btn" aria-label="Edit" data-act="edit">‚úèÔ∏è</button>
          <button class="btn danger" aria-label="Delete" data-act="del">üóëÔ∏è</button>
        </div>`;
      el.querySelector('[data-act="edit"]').onclick = ()=> openEditDialog(e.id);
      el.querySelector('[data-act="del"]').onclick = ()=> deleteEntry(e.id);
      list.appendChild(el);
    });
  }

  // ======= Foods screen =======
  function ensureCategoryOptions(){
    const sel = $('#filterCategory'); if(sel && sel.options.length<=1){
      for(const c of CATEGORIES){ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);} }
  }
  function renderFoods(){
    ensureCategoryOptions();
    const wrap = $('#foodsList'); wrap.innerHTML='';
    const q = norm($('#foodSearch').value);
    const filterCat = $('#filterCategory').value;
    const sortMode = $('#sortFoods').value;

    let arr = Object.values(foods);
    // filter
    if(filterCat && filterCat!=='all') arr = arr.filter(f=> (f.category||'Other')===filterCat);
    if(q) arr = arr.filter(f=> norm(f.name).includes(q));
    // sort
    if(sortMode==='recent') arr.sort((a,b)=> (b.lastUsedAt||0)-(a.lastUsedAt||0));
    if(sortMode==='name') arr.sort((a,b)=> norm(a.name).localeCompare(norm(b.name)));
    if(sortMode==='category') arr.sort((a,b)=> (CATEGORIES.indexOf(a.category||'Other') - CATEGORIES.indexOf(b.category||'Other')) || norm(a.name).localeCompare(norm(b.name)) );

    $('#foodsEmpty').hidden = arr.length>0;
    for(const f of arr){
      const row = document.createElement('div'); row.className='food-item';
      const cat = f.category || 'Other';
      row.innerHTML = `
        <div class="food-left">
          <div class="food-ico">${iconFor(cat)}</div>
          <div>
            <div class="food-name">${f.name}</div>
            <div class="food-sub">${fmtKcal(f.calories)} ‚Ä¢ ${cat} ‚Ä¢ used ${f.timesUsed||0}√ó</div>
          </div>
        </div>
        <div class="food-row-right">
          <select class="catSelect" data-name="${f.name}"></select>
          <button class="btn" data-act="quick">‚ûï Add</button>
          <button class="btn" data-act="del">üóëÔ∏è</button>
        </div>`;
      const sel = row.querySelector('.catSelect');
      for(const c of CATEGORIES){ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);} sel.value = cat;
      sel.onchange = (e)=> setFoodCategory(f.name, e.target.value);
      row.querySelector('[data-act="quick"]').onclick = ()=> openAddDialog({name:f.name, calories:f.calories, when:new Date()});
      row.querySelector('[data-act="del"]').onclick = ()=> { if(confirm('Forget this saved food?')) deleteFood(f.name); };
      wrap.appendChild(row);
    }
  }
  $('#foodSearch').addEventListener('input', renderFoods);
  $('#filterCategory').addEventListener('change', renderFoods);
  $('#sortFoods').addEventListener('change', renderFoods);

  // ======= Entry CRUD =======
  const dlg = $('#entryDialog');
  function openAddDialog(prefill={}){
    $('#dlgTitle').textContent = prefill.id? 'Edit entry' : 'Add entry';
    $('#foodName').value = prefill.name||'';
    $('#calories').value = (prefill.calories!=null? prefill.calories : '');
    $('#when').value = toLocalDatetime(prefill.when||new Date());
    if(prefill.id){ dlg.dataset.mode='edit'; dlg.dataset.id=prefill.id; } else { dlg.dataset.mode='add'; dlg.removeAttribute('data-id'); }
    dlg.showModal();
  }
  function openEditDialog(id){
    const e = entries.find(x=>x.id===id); if(!e) return;
    openAddDialog({ id:e.id, name:e.name, calories:(e.calories ?? e.total ?? 0), when:e.when });
  }
  $('#cancelDlg').onclick = ()=> dlg.close();

  // Autofill calories from memory when name matches
  $('#foodName').addEventListener('input', ()=>{
    const val = $('#foodName').value;
    const c = findFood(val);
    if(c!=null && !$('#calories').value){ $('#calories').value = c; }
  });

  $('#entryForm').onsubmit = (ev)=>{
    ev.preventDefault();
    const data = {
      name: $('#foodName').value.trim(),
      calories: Number($('#calories').value)||0,
      when: new Date($('#when').value)
    };
    if(!data.name){ alert('Please enter a name'); return; }

    if(dlg.dataset.mode==='edit'){
      const id = dlg.dataset.id; const idx = entries.findIndex(e=>e.id===id); if(idx<0) return;
      entries[idx] = { ...entries[idx], name:data.name, calories:data.calories, total:data.calories, when:data.when };
    } else {
      entries.push({ id:uid(), name:data.name, calories:data.calories, total:data.calories, when:data.when });
    }
    rememberFood(data.name, data.calories);
    persist(); computeTotals(); renderLog(); updateCalChart(activeChartRange);
    dlg.close();
  }

  function deleteEntry(id){
    if(!confirm('Delete this entry?')) return;
    entries = entries.filter(e=>e.id!==id); persist(); renderLog(); computeTotals(); updateCalChart(activeChartRange);
  }

  // ======= Barcode scanning & lookup =======
  let codeReader; let selectedDeviceId=null; let controls=null;
  async function listCameras(){ return await ZXingBrowser.BrowserCodeReader.listVideoInputDevices(); }
  async function startScanner(){
    if(!codeReader) codeReader = new ZXingBrowser.BrowserMultiFormatReader();
    const devices = await listCameras();
    if(!devices.length){ alert('No camera found. Try manual barcode entry.'); return; }
    if(!selectedDeviceId){ const back = devices.find(d=>/back|rear|environment/i.test(d.label)); selectedDeviceId = (back||devices[devices.length-1]).deviceId; }
    $('#startScan').disabled = true; $('#stopScan').disabled = false;
    const videoElem = $('#video');
    try{
      controls = await codeReader.decodeFromVideoDevice(selectedDeviceId, videoElem, (result, err)=>{ if(result){ onBarcode(result.getText()); } });
    }catch(e){ console.error(e); alert('Could not start camera.'); $('#startScan').disabled=false; $('#stopScan').disabled=true; }
  }
  function stopScanner(){ try{ controls && controls.stop(); }catch(e){} $('#startScan').disabled=false; $('#stopScan').disabled=true; }
  async function onBarcode(code){ stopScanner(); $('#manualBarcode').value = code; await lookup(code); }
  async function lookup(code){
    if(!/^[0-9]{6,14}$/.test(code||'')) { alert('Enter a valid numeric barcode.'); return; }
    const resBox = $('#scanResult'); resBox.innerHTML = '<div class="muted">Looking up‚Ä¶</div>';
    try{
      const url = `https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(code)}.json`;
      const resp = await fetch(url); const data = await resp.json();
      if(data.status!==1){ resBox.innerHTML = '<div class="empty">Product not found. Add it manually.</div>'; return; }
      const p = data.product||{}; const nutr = p.nutriments||{};
      const name = [p.product_name, p.brands].filter(Boolean).join(' ‚Ä¢ ') || 'Unknown product';
      let kcalServing = Number(nutr['energy-kcal_serving']);
      if(!kcalServing){ const per100 = Number(nutr['energy-kcal_100g']); if(per100 && p.serving_quantity){ kcalServing = per100 * (Number(p.serving_quantity)/100); } }
      if(!kcalServing){ const kjServing = Number(nutr['energy_serving']); if(kjServing) kcalServing = kjServing/4.184; }
      kcalServing = Math.round(kcalServing || 0);
      resBox.innerHTML = '';
      openAddDialog({ name, calories:kcalServing, when:new Date() });
    }catch(e){ console.error(e); resBox.innerHTML = '<div class="empty">Lookup failed. Try again later or add manually.</div>'; }
  }
  $('#startScan').onclick = startScanner; $('#stopScan').onclick = stopScanner; $('#lookupBarcode').onclick = ()=> lookup($('#manualBarcode').value.trim());

  // ======= Charts =======
  let progressChart, calChart; let activeChartRange='day';
  // Center text plugin (only for doughnut)
  Chart.register({ id:'centerText', afterDraw(chart){ try{ if(chart.config.type!=='doughnut') return; const {ctx} = chart; const meta = chart.getDatasetMeta(0).data[0]; if(!meta) return; ctx.save(); ctx.font='700 18px system-ui'; ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle'; const total = chart.data.datasets[0].data[0]||0; ctx.fillText(`${Math.round(total)} kcal`, meta.x, meta.y); ctx.restore(); }catch(_){} }});
  // Goal line plugin for bar charts
  Chart.register({ id:'goalLine', afterDatasetsDraw(chart, args, pluginOptions){ try{
      if(chart.config.type!=='bar') return; const y = chart.scales?.y?.getPixelForValue(pluginOptions?.yValue); if(!y) return; const {ctx, chartArea:{left,right}} = chart;
      ctx.save(); ctx.strokeStyle = pluginOptions?.color || '#9aa1ac66'; ctx.setLineDash([6,4]); ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke(); ctx.setLineDash([]);
      ctx.fillStyle = pluginOptions?.textColor || '#9aa1ac'; ctx.font='600 12px system-ui'; ctx.textAlign='right'; ctx.fillText('Goal', right-6, y-6); ctx.restore();
    }catch(_){} } });

  function initProgressChart(){
    const ctx = document.getElementById('progressChart');
    progressChart = new Chart(ctx, { type:'doughnut', data:{ labels:['Consumed','Remaining'], datasets:[{ data:[0, dailyGoal], borderWidth:0, cutout:'70%' }]}, options:{ responsive:true, plugins:{legend:{display:false}}, maintainAspectRatio:false } });
  }
  function updateProgressChart(consumed, goal){
    if(!progressChart) return; const remaining = Math.max(goal - consumed, 0);
    progressChart.data.datasets[0].data = [Math.max(consumed,0), remaining]; progressChart.update();
  }

  function bucketize(range){
    const now = new Date();
    if(range==='day'){
      const labels = Array.from({length:24}, (_,h)=> h+':00');
      const values = Array(24).fill(0);
      entries.forEach(e=>{ const d=new Date(e.when); if(d.toDateString()===now.toDateString()){ values[d.getHours()] += (e.total||e.calories||0); }});
      return {labels, values};
    }
    if(range==='week'){
      const labels=[]; const values=[];
      for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); d.setHours(0,0,0,0);
        labels.push(d.toLocaleDateString(undefined,{weekday:'short'}));
        const sum = entries.filter(e=>{ const de=new Date(e.when); const ds=new Date(d); const de0=new Date(de.getFullYear(),de.getMonth(),de.getDate()); return de0.getTime()===ds.getTime();}).reduce((a,b)=>a+(b.total||b.calories||0),0);
        values.push(sum); }
      return {labels, values};
    }
    if(range==='month'){
      const labels=[]; const values=[]; const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
      for(let i=1;i<=daysInMonth;i++){ const d=new Date(now.getFullYear(),now.getMonth(),i); labels.push(String(i)); const sum = entries.filter(e=>{ const de=new Date(e.when); return de.getFullYear()===d.getFullYear() && de.getMonth()===d.getMonth() && de.getDate()===d.getDate(); }).reduce((a,b)=>a+(b.total||b.calories||0),0); values.push(sum); }
      return {labels, values};
    }
  }
  function initCalChart(){
    const ctx = document.getElementById('calChart');
    const {labels, values} = bucketize('day');
    calChart = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Calories', data: values, borderRadius: 6, maxBarThickness: 32 }]},
      options:{
        responsive:true,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=> `${Math.round(ctx.parsed.y)} kcal` } }, goalLine:{ yValue: dailyGoal } },
        scales:{
          x:{ grid:{ display:false } },
          y:{ beginAtZero:true, title:{display:true,text:'kcal'}, grid:{ color:'#1f2330' } }
        }
      }
    });
  }
  function updateCalChart(range){ activeChartRange=range; const {labels, values} = bucketize(range); calChart.data.labels=labels; calChart.data.datasets[0].data=values; calChart.options.plugins.goalLine.yValue = dailyGoal; calChart.update(); }

  // ======= Settings & actions =======
  $('#saveGoal').onclick = ()=>{ dailyGoal = Math.max(500, Number($('#dailyGoal').value||2000)); persist(); computeTotals(); if(calChart){ calChart.options.plugins.goalLine.yValue = dailyGoal; calChart.update(); } };
  $('#resetToday').onclick = ()=>{ if(!confirm('Remove all of today\'s entries?')) return; const start = new Date(); start.setHours(0,0,0,0); entries = entries.filter(e=> new Date(e.when) < start); persist(); renderLog(); computeTotals(); updateCalChart(activeChartRange); };
  $('#exportData').onclick = ()=>{ const blob = new Blob([JSON.stringify({entries,dailyGoal,foods},null,2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'calorie-buddy-backup.json'; a.click(); };
  $('#importDataBtn').onclick = ()=> $('#importFile').click();
  $('#importFile').onchange = (ev)=>{ const f = ev.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload = ()=>{ try{ const obj = JSON.parse(reader.result); if(obj.entries){ entries = obj.entries; } if(obj.dailyGoal){ dailyGoal = obj.dailyGoal; } if(obj.foods){ foods = obj.foods; } persist(); buildFoodSuggestions(); renderFoods(); renderLog(); computeTotals(); updateCalChart(activeChartRange); }catch(e){ alert('Invalid file.'); } }; reader.readAsText(f); };
  $('#clearAll').onclick = ()=>{ if(confirm('This will erase all entries & foods. Continue?')){ entries=[]; foods={}; persist(); buildFoodSuggestions(); renderFoods(); renderLog(); computeTotals(); updateCalChart(activeChartRange);} };

  // ======= Wire up UI =======
  $('nav.bottom').addEventListener('click', (e)=>{ const btn = e.target.closest('button[data-screen]'); if(!btn) return; showScreen(btn.dataset.screen); });
  $('#addQuick').onclick = ()=> openAddDialog({when:new Date()});
  $('#scanSwitch').onclick = ()=> showScreen('scan');

  // Chart range buttons
  $$('#screen-charts [data-chart]').forEach(b=> b.onclick = ()=>{ $$('#screen-charts [data-chart]').forEach(x=>x.classList.remove('primary')); b.classList.add('primary'); updateCalChart(b.dataset.chart); });

  // ======= Boot =======
  function boot(){
    // Ensure all category options exist
    ensureCategoryOptions();
    $('#dailyGoal').value = dailyGoal; $('#dailyGoalLabel').textContent = dailyGoal;
    buildFoodSuggestions(); renderFoods(); renderLog();
    initProgressChart(); computeTotals();
    initCalChart(); updateCalChart('day');
    showScreen('home');
  }
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ computeTotals(); renderLog(); updateCalChart(activeChartRange);} });
  boot();
  </script>
</body>
</html>
